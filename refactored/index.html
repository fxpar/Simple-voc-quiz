<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<title>title</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<meta name="description" content="Quiz ou flashcard pour apprendre du vocabulaire en le répétant." />
	<meta name ="revised" content ="François Parlant, 2020/04/01" />
	<meta name="author" content="François parlant">
	<meta name="keywords" content="" />
	<meta name="robots" content="index,follow" />
	<link rel="stylesheet" type="text/css" href="styles.css" />
	<style>
.page-header {
	font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
	color: #fff;
	text-align: center;
	background-color: #159957;
	background-image: linear-gradient(120deg, #155799, #159957);
}

	#qbar {
        /* style de la barre du haut avec les traits pour chaque réponse */
        text-align:left;}
	.w {
        /* couleur des mauvaises réponses Wrong */
        color:lightgrey;}
	.c {
        /* couleur des bonnes réponses Correct */
        color:grey;}

	
		#qcue{
            /* style de la question */
	min-height:40px;
	}
	summary {
        /* style du menu dépliable "vocabulaire" */
		margin-left:25%;
	}

	#qlabel, summary{
	color: grey;
	}
	.card {
        /* style de la partie quiz */
	text-align:center;
	box-shadow: 0 2px 2px 0 rgba(0,0,0,.14),0 3px 1px -2px rgba(0,0,0,.2),0 1px 5px 0 rgba(0,0,0,.12);
    /* margin auto permet l'alignement au milieu */
	margin:auto;
	width:50%;
	 min-width: 200px;
	 height: 200px;
	 
	}
	
	@media only screen and (max-width: 600px) {
  .card {
	margin:auto;
	text-align:center;
	width:90%;
	 height: 200px;
	}
	
	summary {
		margin-left:5%;
	}
}
	
	</style>

<script>
    /**
     * @class Quiz
     * @property {function} show - affiche les éléments sur la page
     * @property {function} load - charge les questions du vocabulaire
     * @property {function} play - joue la question suivante, ou la fin, ou le redémarrage
	 * @todo: ajouter barre de progression - - - 
	 * @todo: ajouter un json avec l'internationalisation 
     **/
function Quiz(){
   
    console.log("initialize quiz");
    this.sep = "\t"; // separateur par défaut pour découper le vocabulaire
    this.defaultSource = document.getElementById("voc1");// définit l'élément qui contient la source par défaut où trouver le vocabulaire
    this.headers = []; //entête du vocabulaire = les titres
    this.jsonObj = []; // array d'objets contenant chaque éléments de vocabulaire
	this.txtLevel =document.getElementById("levels").selected; // nom du niveau selectionné par la liste déroulante id=levels
	this.levels = new Set(); // un "set" est un array unique, sans doublons. on est sûr qu'il ne seront pas répétés.
	this.levelIndex = 0;
	this.questionSet = []; // filtre du vocabulaire sur le niveau choisi
    this.qnum =0; // initialisation du numéro de la question à 0
	this.state = "notReady";
	this.numLevelCol = 0;
	this.numQstCueCol = 1;
	this.numQstAnswCol = 2;
    
/**
 * Affiche les différents éléments
 * Tous les paramètres sont du texte
 * Généralement appelé par {@link this.showNum()}
 * @param {string} qcue - la question ex: "strawberry"
 * @param {string} qlabel - le nom de la colonne pour la réponse attendue ex: "Français"
 * @param {string} qcorr - la bonne réponse doit être vide quand on est en phase de pose de question
 * @param {string} uanswer - la réponse de l'utilisateur = value d'un textarea
 **/
    this.show = function(qcue="&nbsp;", qlabel="&nbsp;", qcorr="&nbsp;", uanswer="", qnum="&nbsp;", qhint="&nbsp;", buttontxt="▻" ){
        document.getElementById("qcue").innerHTML = qcue.trim();
        document.getElementById("qlabel").innerHTML = qlabel.trim();
        document.getElementById("qcorr").innerHTML = qcorr.trim();
        document.getElementById("uanswer").value = uanswer.trim();
        document.getElementById("qnum").innerHTML = qnum.trim();
        //document.getElementById("qhint").innerHTML = qhint.trim(); // un indice: inutilisé pour l'instant, aucun élément id="qhint"
    }

/**
 * Charge le vocabulaire depuis la source par défaut
 * utilise le séparateur \t tab par défaut
 * ajouter le titre des colonne à l'array headers (première ligne)
 * @return: l'array of objects jsonObj contenant les lignes de questions
 **/
    this.load = function(){
       
		console.log("this.load");
		// enregistre le numéro du niveau actuel dans la liste des "levels"
		this.levelIndex = document.getElementById("levels").selectedIndex;
		console.log("niveau avant update:"+this.levelIndex);
        // remet à 0 le jsonObj pour que ça n'ajoute pas les nouvelles questions aux précédentes
		this.jsonObj = [];
        // charger la source par défaut textarea id=voc1
		rawVoc = this.defaultSource.value.trim();
		
		arr = rawVoc.split('\n'); // sépare chaque ligne et le met dans arr

		/*
		 Insère les titres des colonnes dans quiz.headers
		*/
		this.headers = arr[0].split(this.sep);

        /*
         charge le vocabulaire dans jsonObj
        */
	   //boucle sur chaque ligne i
		for(var i = 1; i < arr.length; i++) {
		  var data = arr[i].split(this.sep);
		  var obj = {};
		  //boucle sur chaque colonne j de la ligne i 
		  for(var j = 0; j < data.length; j++) {
			 obj[this.headers[j].trim()] = data[j].trim();
		  }
		  this.jsonObj.push(obj);
		  this.levels.add(data[this.numLevelCol].trim());
		  
		  //<option value="Level01" selected>Level01</option>
		  //this.levels.add('<option value="'+data[this.numLevelCol].trim()+'">'+data[this.numLevelCol].trim()+'</option>');
		}
		//this.qCol = this.headers[0];
		//this.qlabel = this.headers[1];
		
		//console.log(this.jsonObj);
		//console.log(this.levels);
		
		this.state = "ready";
	}

	/**
	 * Créer la list déroulante des niveaux
	 * ajouter le selected par défaut sur le premier
	 * 
	 **/
	this.setLevelsList= function(){
		// attention: les Set ont une size, pas une length!
		var e =  document.getElementById("levels");
		//var eIndex = e.selectedIndex;
		console.log("début e.selectedIndex:"+e.selectedIndex);
		console.log("setLevelsList"+this.levels.size);
		var a = "";
		for (let item of this.levels) a += '<option value="'+item+'">'+item+'</option>';
		console.log(a);
		
		document.getElementById("levels").innerHTML = a;

		if (this.levelIndex ==-1 || this.levelIndex > this.levels.size){
			console.log("reset this.levelIndex to 0");
			this.levelIndex = 0;
		}
		console.log("after this.levelIndex:"+this.levelIndex);
		e.selectedIndex = this.levelIndex;
		//this.txtLevel = document.getElementById("levels").selected;
		console.log("Selected:"+document.getElementById("levels").selected);
		console.log("levels options added");

		//var val = 3;    
	//	document.querySelector('#levels [value="' + this.txtLevel + '"]').selected = true;
	}

    /**
     * Lance l'affichage d'une question particulière, avec sa correction ou non
     * @param {integer} num - le numéro de la question commençant à 0
     * @param {boolean} corr - défaut false; true pour afficher la correction de la question
     **/
    this.showNum = function(num, corr = false){
        if (corr == false){
            var correction = "&nbsp;";
        }else{
           var correction = this.jsonObj[this.qnum][this.headers[this.numQstAnswCol]];
        }
        this.show(this.jsonObj[this.qnum][this.headers[this.numQstCueCol]], this.headers[this.numQstAnswCol], correction);
    }
	this.showFinish = function(){
		this.show( "bravo!!!");

	}
	
	this.checkAnswer = function(){
		if(this.jsonObj[this.qnum][this.headers[this.numQstAnswCol]].toLowerCase() == document.getElementById("uanswer").value.toLowerCase()){
			return true;
		}else{
			return false;
		}
	}


/**
 * filtrer par le niveau sélectionné dans la liste déroulante des niveaux
 * */
	this.filterLevel = function(){
		this.txtLevel = document.getElementById("levels").value;
		//console.log(this.txtLevel);
		//this.jsonObj = this.jsonObj.filter(document.getElementById("levels").value);
		//console.log("TEST:"+this.jsonObj[2]["Chinois"]);
		//console.log("TEST:"+this.jsonObj[2].Chinois);
		this.jsonObj = this.jsonObj.filter(q => q.Level == this.txtLevel);
		//this.jsonObj = this.jsonObj.filter(q => q.Level === 'Level02');
		
	}


	
	/**
	 * Principale fonction pour afficher les questions 
	 * passer à la questions suivantes
	 * vérifier les questions, afficher le succès, recommencer.
	 * Déclenchée au chargement de la page et à chaque clique sur le bouton suivant.
	 **/
	this.play = function(){
		if (this.state == "notReady"){
			this.load();
			//this.show( "ajoutez du vocabulaire");
		}else if (this.qnum == this.jsonObj.length ){
			this.showFinish();
			this.state == "ready";
			this.qnum = 0;
		}else if (this.state == "ready"){
			this.showNum(this.qnum);
			this.state = "checkAnswer";
		}else if(this.state == "checkAnswer"){
			if(this.checkAnswer() == true){
				this.qnum++;
				this.state = "ready";
				this.play();
			}else{
				this.showNum(this.qnum, true);
				this.qnum++;
				this.state = "ready";
			}
		};
		console.log("play:"+this.qnum);
		//this.showNum(this.qnum);
		
		//this.show(this.jsonObj[this.qnum][this.qlabel], this.headers[1]);
		
	}

	/**
	 * Execute les méthodes de lancement du quiz
	 **/    
	this.init = function(){
		this.load(); // charger le quiz et le vocabulaire
		this.setLevelsList(); // peuple la liste déroulante des niveaux
		this.filterLevel();// filtre les questions par le niveau choisis
		this.play(); // lance la première question
		//this.show(this.jsonObj[this.qnum][this.qlabel], this.headers[1]); // juste pour tester

	}

	/**
	 * lance la construction lors de l'instanciation du quiz
	 **/ 
	this.init();
}



//function QuestionSet(){

//}


	
</script>
	
	
	
</head>

<body  onload="quiz = new Quiz();">
	<section class="page-header">
      <h1 class="project-name">Simple-voc-quiz</h1>
      <h2 class="project-tagline">One page flashcard quiz</h2>
      
        <a href="https://github.com/fxpar/Simple-voc-quiz" class="btn">View on GitHub</a>
      
      
    </section>
<div class="card">
	<div id="qbar">&nbsp;</div>
	<div id="qnum">&nbsp;</div>
	<div id="qcue">&nbsp;</div>
	<div id="qcorr">&nbsp;</div>
	<form action="#" onsubmit="return false">
		<label id="qlabel" for="uanswer">vocabulaire</label>
		<input type="text" id="uanswer" autofocus autocomplete="off"></input>
		<button onclick="quiz.play();">&nbsp; ▻ &nbsp;</button>
	</form>
</div>
<div>&nbsp;</div>
<div>&nbsp;</div>

<details>
<summary>💬voc</summary>
<form name="vocForm" id="vocForm"  autocomplete="off" action="#" onsubmit="return false">
<select name="levels" id="levels" autocomplete="off">
	

</select>


<textarea  type="text" rows="5" style="width:100%" id="voc1" >
Level	Chinois	Pin1yin1	Pinyin	English	Français
Level01	人	ren2	rén	person	
Level01	女人	nü3 ren2	nǚ rén	woman	
Level01	男人	nan2 ren2	nán rén	man	
Level01	女孩	nü3 hai2	nǚ hái	girl	
Level02	蓝	lan2	lán	blue	
Level02	白	bai2	bái	white	
Level02	黑	hei1	hēi	black	
Level02	天	tian1	tiān	sky
Level03	一	yi1	yī	one	
Level03	二	er4	èr	two	
Level03	两	liang3	liǎng	a pair, two	
Level03	三	san1	sān	three	
Level03	四	si4	sì	four	
Level03	五	wu3	wǔ	five	
Level03	六	liu4	liù	six	
Level03	杯	bei1	bēi	cup	
Level04	苹果	ping2 guo3	píng guǒ	apple	
Level04	芒果	mang2 guo3	máng guǒ	mango	
Level04	西瓜	xi1 gua1	xīguā	watermelon	
Level04	木瓜	mu4 gua1	mù guā	papaya	</textarea>
<button onclick="quiz.init();">update</button>
</form>
</details>
</body>
</html>
